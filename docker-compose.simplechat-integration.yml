version: '3.8'

# =============================================================================
# SimpleChat + Platform Engineering Copilot MCP Integration
# =============================================================================
# This Docker Compose file integrates the Platform Engineering Copilot MCP
# server with Microsoft SimpleChat application.
#
# Usage:
#   docker-compose -f docker-compose.simplechat-integration.yml up -d
#
# Services:
#   - SimpleChat Frontend (React) - Port 3000
#   - SimpleChat Backend (Python/Flask) - Port 8080
#   - Platform MCP Server (C#/.NET) - Port 5100
#   - SQL Server (MCP Database) - Port 1433
#   - Cosmos DB Emulator (SimpleChat) - Port 8081
# =============================================================================

networks:
  simplechat-network:
    driver: bridge
    name: simplechat-network

volumes:
  platform-mcp-sqlserver-data:
    name: platform-mcp-sqlserver-data
  platform-mcp-logs:
    name: platform-mcp-logs
  simplechat-cosmos-data:
    name: simplechat-cosmos-data
  simplechat-ai-search-data:
    name: simplechat-ai-search-data

services:
  # ===========================================================================
  # Platform Engineering Copilot MCP Server
  # ===========================================================================
  
  # SQL Server Database for MCP
  platform-mcp-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: platform-mcp-sqlserver
    hostname: platform-mcp-sqlserver
    restart: unless-stopped
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${PLATFORM_MCP_SA_PASSWORD:-PlatformMcpDB123!}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - platform-mcp-sqlserver-data:/var/opt/mssql
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql:ro
    networks:
      - simplechat-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${PLATFORM_MCP_SA_PASSWORD:-PlatformMcpDB123!} -C -Q 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Platform MCP Server (HTTP Mode for SimpleChat Integration)
  platform-mcp:
    build:
      context: .
      dockerfile: src/Platform.Engineering.Copilot.Mcp/Dockerfile
      target: final
    image: platform-engineering-copilot-mcp:latest
    container_name: platform-mcp
    hostname: platform-mcp
    restart: unless-stopped
    depends_on:
      platform-mcp-sqlserver:
        condition: service_healthy
    environment:
      # ASP.NET Core Configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5100
      - ASPNETCORE_HTTP_PORTS=5100
      
      # Database Configuration
      - ConnectionStrings__DefaultConnection=Server=platform-mcp-sqlserver,1433;Database=PlatformEngineeringCopilotDb;User=sa;Password=${PLATFORM_MCP_SA_PASSWORD:-PlatformMcpDB123!};TrustServerCertificate=true;MultipleActiveResultSets=true;Encrypt=false
      - ConnectionStrings__SqlServerConnection=Server=platform-mcp-sqlserver,1433;Database=PlatformEngineeringCopilotDb;User=sa;Password=${PLATFORM_MCP_SA_PASSWORD:-PlatformMcpDB123!};TrustServerCertificate=true;MultipleActiveResultSets=true;Encrypt=false
      - DatabaseProvider=SqlServer
      
      # Azure SDK Environment Variables (required for DefaultAzureCredential)
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_SUBSCRIPTION_ID=${AZURE_SUBSCRIPTION_ID}
      
      # Azure AD Authentication (Optional - for CAC/PIV)
      - AzureAd__Instance=${AZURE_AD_INSTANCE:-https://login.microsoftonline.us/}
      - AzureAd__TenantId=${AZURE_AD_TENANT_ID:-}
      - AzureAd__ClientId=${AZURE_AD_CLIENT_ID:-}
      - AzureAd__ClientSecret=${AZURE_AD_CLIENT_SECRET:-}
      - AzureAd__Audience=${AZURE_AD_AUDIENCE:-}
      - AzureAd__RequireMfa=${AZURE_AD_REQUIRE_MFA:-false}
      - AzureAd__RequireCac=${AZURE_AD_REQUIRE_CAC:-false}
      
      # Gateway - Azure Configuration
      - Gateway__Azure__SubscriptionId=${AZURE_SUBSCRIPTION_ID}
      - Gateway__Azure__ClientId=${AZURE_CLIENT_ID}
      - Gateway__Azure__ClientSecret=${AZURE_CLIENT_SECRET}
      - Gateway__Azure__TenantId=${AZURE_TENANT_ID}
      - Gateway__Azure__CloudEnvironment=${AZURE_CLOUD_ENVIRONMENT:-AzureGovernment}
      - Gateway__Azure__UseManagedIdentity=${AZURE_USE_MANAGED_IDENTITY:-false}
      - Gateway__Azure__Enabled=${AZURE_ENABLED:-true}
      
      # Gateway - Azure OpenAI Configuration
      - Gateway__AzureOpenAI__ApiKey=${AZURE_OPENAI_API_KEY}
      - Gateway__AzureOpenAI__Endpoint=${AZURE_OPENAI_ENDPOINT}
      - Gateway__AzureOpenAI__DeploymentName=${AZURE_OPENAI_DEPLOYMENT:-gpt-4o}
      - Gateway__AzureOpenAI__ChatDeploymentName=${AZURE_OPENAI_CHAT_DEPLOYMENT:-gpt-4o}
      - Gateway__AzureOpenAI__EmbeddingDeploymentName=${AZURE_OPENAI_EMBEDDING_DEPLOYMENT:-text-embedding-ada-002}
      - Gateway__AzureOpenAI__UseManagedIdentity=${AZURE_OPENAI_USE_MANAGED_IDENTITY:-false}
      
      # Gateway - GitHub Configuration (Optional)
      - Gateway__GitHub__AccessToken=${GITHUB_TOKEN:-}
      - Gateway__GitHub__ApiBaseUrl=${GITHUB_API_BASE_URL:-https://api.github.com}
      - Gateway__GitHub__DefaultOwner=${GITHUB_DEFAULT_OWNER:-}
      - Gateway__GitHub__Enabled=${GITHUB_ENABLED:-false}
      
      # Gateway - Timeouts
      - Gateway__ConnectionTimeoutSeconds=${GATEWAY_CONNECTION_TIMEOUT:-60}
      - Gateway__RequestTimeoutSeconds=${GATEWAY_REQUEST_TIMEOUT:-300}
      
      # NIST Controls Configuration
      - NistControls__BaseUrl=${NIST_CONTROLS_BASE_URL:-https://raw.githubusercontent.com/usnistgov/oscal-content/main/nist.gov/SP800-53/rev5/json}
      - NistControls__TimeoutSeconds=${NIST_CONTROLS_TIMEOUT:-60}
      - NistControls__CacheDurationHours=${NIST_CONTROLS_CACHE_DURATION:-24}
      - NistControls__MaxRetryAttempts=${NIST_CONTROLS_MAX_RETRIES:-3}
      - NistControls__RetryDelaySeconds=${NIST_CONTROLS_RETRY_DELAY:-2}
      - NistControls__EnableOfflineFallback=${NIST_CONTROLS_OFFLINE_FALLBACK:-true}
      - NistControls__EnableDetailedLogging=${NIST_CONTROLS_DETAILED_LOGGING:-false}
      
      # Evidence Storage Configuration (Optional)
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING:-DefaultEndpointsProtocol=https;AccountName=;AccountKey=Z4paJbETBOfhsR+u6y61KlKbwAo0DQzGKh7KBzu29elVGK2zG9jP5IKvQLqGykpYa34SjXCHcZ9X+AStiPhCyw==;EndpointSuffix=core.usgovcloudapi.net}

    
    ports:
      - "5100:5100"
    
    volumes:
      - platform-mcp-logs:/app/logs
      - ./appsettings.json:/app/appsettings.json:ro
      - ~/.azure:/root/.azure:ro
    
    networks:
      - simplechat-network
    
    # Run in HTTP mode for SimpleChat integration
    command: ["--http", "--port", "5100"]
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5100/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # SimpleChat Services
  # ===========================================================================
  # Note: These services are placeholder configurations.
  # You should replace them with your actual SimpleChat deployment configuration.
  # See: https://github.com/microsoft/simplechat for complete setup instructions.
  # ===========================================================================
  
  # Cosmos DB Emulator (for local development)
  # For production, use Azure Cosmos DB service
  simplechat-cosmos:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
    container_name: simplechat-cosmos
    hostname: simplechat-cosmos
    restart: unless-stopped
    environment:
      - AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10
      - AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE=true
      - AZURE_COSMOS_EMULATOR_IP_ADDRESS_OVERRIDE=0.0.0.0
    ports:
      - "8081:8081"
      - "10251:10251"
      - "10252:10252"
      - "10253:10253"
      - "10254:10254"
    volumes:
      - simplechat-cosmos-data:/data/db
    networks:
      - simplechat-network
    profiles:
      - simplechat-local

  # SimpleChat Backend (Python/Flask)
  # You need to clone https://github.com/microsoft/simplechat and build this image
  simplechat-backend:
    image: simplechat-backend:latest
    container_name: simplechat-backend
    hostname: simplechat-backend
    restart: unless-stopped
    depends_on:
      platform-mcp:
        condition: service_healthy
    environment:
      # SimpleChat Configuration
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT:-gpt-4o}
      - AZURE_COSMOS_ENDPOINT=${SIMPLECHAT_COSMOS_ENDPOINT:-https://simplechat-cosmos:8081}
      - AZURE_COSMOS_KEY=${SIMPLECHAT_COSMOS_KEY}
      - AZURE_AI_SEARCH_ENDPOINT=${SIMPLECHAT_AI_SEARCH_ENDPOINT}
      - AZURE_AI_SEARCH_KEY=${SIMPLECHAT_AI_SEARCH_KEY}
      
      # MCP Integration Configuration
      - MCP_SERVER_URL=http://platform-mcp:5100
      - MCP_ENABLED=${MCP_ENABLED:-true}
      - MCP_TIMEOUT_SECONDS=${MCP_TIMEOUT_SECONDS:-120}
      - MCP_INTENT_THRESHOLD=${MCP_INTENT_THRESHOLD:-0.6}
      
      # Flask Configuration
      - FLASK_ENV=production
      - FLASK_DEBUG=false
    
    ports:
      - "8080:8080"
    
    networks:
      - simplechat-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    profiles:
      - simplechat

  # SimpleChat Frontend (React)
  # You need to clone https://github.com/microsoft/simplechat and build this image
  simplechat-frontend:
    image: simplechat-frontend:latest
    container_name: simplechat-frontend
    hostname: simplechat-frontend
    restart: unless-stopped
    depends_on:
      - simplechat-backend
    environment:
      - REACT_APP_API_URL=http://simplechat-backend:8080
      - REACT_APP_MCP_ENABLED=${MCP_ENABLED:-true}
    
    ports:
      - "3000:3000"
    
    networks:
      - simplechat-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    profiles:
      - simplechat

  # ===========================================================================
  # Optional: Nginx Reverse Proxy
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: simplechat-nginx
    hostname: simplechat-nginx
    restart: unless-stopped
    depends_on:
      - platform-mcp
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-simplechat.conf:/etc/nginx/nginx.conf:ro
    networks:
      - simplechat-network
    profiles:
      - proxy
